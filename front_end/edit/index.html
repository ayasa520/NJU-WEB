<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>编辑图片</title>

    <link rel="stylesheet" type="text/css" href="/css/edit.css" />
    <script src="https://fellipe.com/demos/lena-js/assets/js/lena.js"></script>
  </head>
  <body>
    <div class="toolbar">
      <div class="left">
        <div class="toolbar_item">
          <button type="">打开</button>
        </div>
        <div class="toolbar_item">
          <button type="">保存</button>
        </div>
      </div>
      <div class="center">
        <div class="toolbar_item">
          <button onclick="zoom_out()">-</button>
          <div class="current">
            <div>缩放</div>
            <div id="scale_rate">75%</div>
          </div>
          <button onclick="zoom_in()">+</button>
        </div>
      </div>
    </div>
    <div class="content">
      <!-- <img id="original-image" src="/image/big_img/0.jpg" /> -->
      <canvas id="original-image"></canvas>
      <canvas id="filtered-image"></canvas>
    </div>
    <div class="editor_controls">
      
    </div>
  </body>
  <script>
    var originalImage = document.getElementById("original-image");
    // // The canvas where the processed image will be rendered (With filter)
    var filteredImageCanvas = document.getElementById("filtered-image");

    const paint = (img, dom, rate) => {
      dom.height = img.height * rate;
      dom.width = img.width * rate;
      let ctx = dom.getContext("2d");
      ctx.scale(rate, rate);
      ctx.drawImage(img, 0, 0, img.width, img.height);
    };

    // 如果想拿到 Promise 的东西, 得返回 Promise 然后 then
    function __picWM({ url = "", dom = null } = {}) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = url;
        img.crossOrigin = "anonymous";
        img.onload = function () {
          const rate = (screen.height * 0.6) / img.height;
          const digit = document.getElementById("scale_rate");
          digit.innerText = `${rate * 100}`.slice(0, 2) + "%";

          paint(img, dom, rate);
          resolve(img);
        };
      });
    }
    // filteredImageCanvas.width =1000 ;
    // filteredImageCanvas.height= 2000;
    // // Filter to apply, in this case the red filter
    // var ctx = filteredImageCanvas.getContext("2d");
    // ctx.scale(5,2);

    // ctx.scale(5,9);

    const img_promise = __picWM({
      url: "/image/big_img/0.jpg",
      dom: originalImage,
    });
    __picWM({ url: "/image/big_img/0.jpg", dom: filteredImageCanvas });

    const lvjing = () => {
      const filter = LenaJS["red"];
      LenaJS.redrawCanvas(filteredImageCanvas, filter);
    };

    const zoom_in = () => {
      const digit = document.getElementById("scale_rate");
      const val = Number(digit.innerText.slice(0, -1));
      digit.innerText =
        val + 5 <= 300 &&
        img_promise.then((res) => {
          paint(res, originalImage, (val + 5) / 100);
          paint(res, filteredImageCanvas, (val + 5) / 100);
        })
          ? `${val + 5}%`
          : "300%";
    };
    const zoom_out = () => {
      const digit = document.getElementById("scale_rate");
      const val = Number(digit.innerText.slice(0, -1));
      digit.innerText =
        val - 5 >= 10 &&
        img_promise.then((res) => {
          paint(res, originalImage, (val - 5) / 100);
          paint(res, filteredImageCanvas, (val - 5) / 100);
        })
          ? `${val - 5}%`
          : "10%";
    };
    // Get the image
  </script>
</html>
